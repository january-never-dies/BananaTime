<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover, user-scalable=no" />
  <title>Banana Time</title>
  <meta name="description" content="24/7 With... DDEOSUNGEE!" />
  <style>
    *,*::before,*::after{box-sizing:border-box}
    :root{--bg:#fff9e9;--ink:#1f1f1f;--brand:#ffbd2e;--ui:#242424}
    html,body{height:100%;overflow:hidden}
    body{
      margin:0;background:var(--bg);color:var(--ink);
      font-family:ui-sans-serif,system-ui,-apple-system,Segoe UI,Roboto,Noto Sans KR,Apple SD Gothic Neo,"Apple Color Emoji","Segoe UI Emoji";
      min-height:100dvh; display:grid; place-items:stretch;
    }
    .wrap{
      height:100dvh; width:100vw;
      display:grid; grid-template-rows:1fr auto auto; gap:8px;
      padding: max(8px, env(safe-area-inset-top))
               max(8px, env(safe-area-inset-right))
               max(8px, env(safe-area-inset-bottom))
               max(8px, env(safe-area-inset-left));
    }
    .panel{
      background:#fff;border-radius:14px;box-shadow:0 8px 30px rgba(0,0,0,.08);
      padding:8px; display:grid; grid-template-rows:auto 1fr auto auto; gap:6px; height:100%;
      min-height:0;
    }
    .hud{display:grid;grid-template-columns:1fr auto 1fr;align-items:center;gap:8px;font-weight:800;font-size:14px}
    .center{text-align:center}
    .slot{min-height:0; display:grid; place-items:stretch; overflow:hidden}
    canvas{image-rendering:pixelated; background:linear-gradient(0deg,#fff7d1,#fff1b0); border-radius:12px; display:block; width:100%; height:100%;}
    .group{display:flex;gap:8px;flex-wrap:wrap;justify-content:center}
    button.btn, a.btn{appearance:none;border:none;background:var(--brand);color:#1b1b1b;font-weight:800;padding:9px 12px;border-radius:12px;cursor:pointer;box-shadow:0 6px 16px rgba(0,0,0,.15);text-decoration:none;display:inline-block}
    button.btn:active{transform:translateY(1px)}
    .hidden{display:none!important}
    .footer{font-size:11px;opacity:.7;text-align:center}
  </style>
</head>
<body>
  <div class="wrap">
    <div class="panel">
      <div class="hud">
        <div class="left">점수: <span id="score">0</span></div>
        <div class="center">남은시간: <span id="time">30</span>s</div>
        <div class="right" style="text-align:right">❤️ <span id="lives">3</span> · 최고: <span id="best">0</span></div>
      </div>

      <div class="slot" id="slot">
        <canvas id="game" width="360" height="640" aria-label="WITH Monkey Game"></canvas>
      </div>

      <div class="center group">
        <button class="btn" id="startBtn">떠숭이 밥주기</button>
        <button class="btn hidden" id="shareBtn">결과 공유하기</button>
      </div>

      <div class="center" style="font-size:12px;opacity:.85">
        Golden (+5) / Rotten (❤️-1) / Time(⏱ +2s)
      </div>
    </div>
    <div class="footer">Made by Twitter(@ddeosungee)</div>
  </div>

  <script>
  // ========= CONFIG =========
  const CONFIG = {
    GAME_SECONDS: 30,
    MONKEY_SPEED: 6,
    BASE_SPAWN: 34,
    FALL_MIN: 2,
    FALL_MAX: 5,
    GOLDEN_CHANCE: 0.08,
    ROTTEN_CHANCE: 0.20,   // 조금 줄임
    SHAKE_FRAMES: 18,
    MONKEY_FLASH: 14,
    DRIFT_VX_MAX: 1.6,
    DRIFT_AX: 0.02,
    DRIFT_SIN_MIN: 0.1,
    DRIFT_SIN_MAX: 0.8,
    DRIFT_FREQ_MIN: 0.04,
    DRIFT_FREQ_MAX: 0.10,
    PAIR_CHANCE: 0.28,
    PAIR_SPACING: 42,
    PAIR_VX_PUSH: 0.35,
    TIMEBANANA_PERIOD_S: 4, // 더 자주 나오게
    TIMEBANANA_JITTER_S: 2,
    TIMEBANANA_ADD_S: 2,
    SHOP_URL: "#",
    TITLE_TEXT: "Banana Time"
  };

  // ========= UTIL =========
  function loadImage(src){return new Promise(r=>{const i=new Image();i.onload=()=>r(i);i.onerror=()=>r(null);i.src=src})}
  function clamp(x,a,b){return Math.max(a,Math.min(b,x))}
  function lerp(a,b,t){return a+(b-a)*t}
  function rand(min,max){return Math.random()*(max-min)+min}
  function hit(a,b){return Math.abs(a.x-b.x)<(a.w/2+b.w/2)&&Math.abs(a.y-b.y)<(a.h/2+b.h/2)}

  // ========= DOM =========
  const canvas=document.getElementById('game');
  const slot=document.getElementById('slot');
  const ctx=canvas.getContext('2d'); ctx.imageSmoothingEnabled=false;
  const ui={
    score:document.getElementById('score'), time:document.getElementById('time'), best:document.getElementById('best'),
    lives:document.getElementById('lives'), startBtn:document.getElementById('startBtn'),
    shareBtn:document.getElementById('shareBtn')
  };

  function fitCanvas(){
    const W = slot.clientWidth;
    const H = slot.clientHeight;
    canvas.width = W;
    canvas.height = H;
    canvas.style.width = '100%';
    canvas.style.height = '100%';
  }
  addEventListener('resize', fitCanvas);
  addEventListener('orientationchange', fitCanvas);
  if (window.visualViewport) { visualViewport.addEventListener('resize', fitCanvas); }

  // ========= STATE =========
  const state={
    running:false, frame:0, score:0, timeLeft:CONFIG.GAME_SECONDS,
    lives:3, shake:0, monkeyFlash:0,
    monkey:{x:180,y:560,w:88,h:88}, bananas:[],
    assets:{monkey:null,banana:null,gold:null,rotten:null,time:null,heart:null,logo:null},
    lastTick:0, spawnEvery:CONFIG.BASE_SPAWN, rafId:null, timeAcc:0,
    timeBananaFrames: 0,
    bubble:{text:'',frames:0},
    floaters:[]
  };

  // ========= INPUT =========
  const keys=new Set(); addEventListener('keydown',e=>keys.add(e.key)); addEventListener('keyup',e=>keys.delete(e.key));

  let lastPointerX = null;
  function pointerMove(clientX){
    if(lastPointerX !== null){
      const dx = clientX - lastPointerX;
      state.monkey.x = clamp(state.monkey.x + dx, state.monkey.w/2, canvas.width - state.monkey.w/2);
    }
    lastPointerX = clientX;
  }
  canvas.addEventListener('mousemove', e => pointerMove(e.clientX));
  canvas.addEventListener('touchmove', e => { if(e.touches[0]) pointerMove(e.touches[0].clientX); }, {passive:true});

  ui.startBtn.addEventListener('click',startGame);
  ui.shareBtn.addEventListener('click',share);

  // ========= GAME LOOP =========
  function startGame(){
    if(state.rafId){ cancelAnimationFrame(state.rafId); state.rafId = null; }
    state.running=true; state.frame=0; state.score=0; state.timeLeft=CONFIG.GAME_SECONDS; state.lives=3; state.shake=0; state.monkeyFlash=0; state.bananas=[]; state.spawnEvery=CONFIG.BASE_SPAWN;
    state.timeAcc = 0;
    state.monkey.x = canvas.width/2;
    state.monkey.y = canvas.height - 80;
    lastPointerX = null;
    ui.score.textContent='0'; ui.time.textContent=CONFIG.GAME_SECONDS; ui.lives.textContent='3'; ui.startBtn.textContent='다시 시작'; ui.shareBtn.classList.add('hidden');
    resetTimeBananaTimer();
    canvas.onclick = null;
    state.lastTick = performance.now();
    state.rafId = requestAnimationFrame(loop);
  }

  function loop(now){
    if(!state.running) return;
    const dt = (now - state.lastTick) / 1000 || 0;
    state.lastTick = now;
    state.timeAcc += dt;
    while(state.timeAcc >= 1 && state.running){
      state.timeLeft = Math.max(0, state.timeLeft - 1);
      state.timeAcc -= 1;
    }
    ui.time.textContent = state.timeLeft;
    if(state.timeLeft <= 0 || state.lives <= 0){ endGame(); return; }
    update(); draw(); state.frame++;
    state.rafId = requestAnimationFrame(loop);
  }

  // ========= SPAWN =========
  function spawnOne(kind){ state.bananas.push({kind,x:rand(24,canvas.width-24),y:-30,vx:(Math.random()-0.5),vy:lerp(CONFIG.FALL_MIN,CONFIG.FALL_MAX,Math.random()),w:46,h:46,phase:Math.random()*Math.PI*2,sinAmp:0.4,sinFreq:0.08,ax:0}); }
  function spawnPair(){ 
    const centerX = rand(40, canvas.width-40);
    const leftX = clamp(centerX - CONFIG.PAIR_SPACING/2, 16, canvas.width-16);
    const rightX = clamp(centerX + CONFIG.PAIR_SPACING/2, 16, canvas.width-16);
    state.bananas.push({kind:'gold', x:leftX, y:-30, vx:-CONFIG.PAIR_VX_PUSH, vy:3, w:46,h:46, phase:0, sinAmp:0.3, sinFreq:0.07, ax:0});
    state.bananas.push({kind:'rotten', x:rightX, y:-30, vx:+CONFIG.PAIR_VX_PUSH, vy:3, w:46,h:46, phase:0, sinAmp:0.3, sinFreq:0.07, ax:0});
  }
  function spawnTimeBanana(){ state.bananas.push({kind:'time',x:rand(24,canvas.width-24),y:-30,vx:(Math.random()-0.5)*0.8,vy:3,w:46,h:46,phase:0,sinAmp:0.3,sinFreq:0.07,ax:0}); }
  function resetTimeBananaTimer(){ const base=CONFIG.TIMEBANANA_PERIOD_S; const j=CONFIG.TIMEBANANA_JITTER_S; const period=(base + (Math.random()*2-1)*j); state.timeBananaFrames=Math.max(2, Math.round(period*60)); }

  // ========= UPDATE =========
  function update(){
    if(keys.has('ArrowLeft')||keys.has('a')) state.monkey.x-=CONFIG.MONKEY_SPEED;
    if(keys.has('ArrowRight')||keys.has('d')) state.monkey.x+=CONFIG.MONKEY_SPEED;
    state.monkey.x=clamp(state.monkey.x, state.monkey.w/2, canvas.width - state.monkey.w/2);

    if(state.frame%state.spawnEvery===0){
      if(Math.random() < CONFIG.PAIR_CHANCE){ spawnPair(); }
      else {
        const r=Math.random(); let kind='normal';
        if(r<CONFIG.ROTTEN_CHANCE) kind='rotten';
        else if(r<CONFIG.ROTTEN_CHANCE+CONFIG.GOLDEN_CHANCE) kind='gold';
        spawnOne(kind);
      }
    }
    state.timeBananaFrames--; if(state.timeBananaFrames<=0){ spawnTimeBanana(); resetTimeBananaTimer(); }

    for(let i=state.bananas.length-1;i>=0;i--){
      const b=state.bananas[i];
      b.x += b.vx; b.y += b.vy;
      if(hit(b,state.monkey)){
        state.bananas.splice(i,1);
        if(b.kind==='rotten'){ state.lives--; ui.lives.textContent=state.lives; }
        else if(b.kind==='time'){ state.timeLeft += CONFIG.TIMEBANANA_ADD_S; }
        else { state.score++; ui.score.textContent=state.score; }
      } else if(b.y>canvas.height+40){ state.bananas.splice(i,1); }
    }
  }

  // ========= DRAW =========
  function draw(){
    ctx.clearRect(0,0,canvas.width,canvas.height);
    ctx.fillStyle='#fff7d1'; ctx.fillRect(0,0,canvas.width,canvas.height);
    ctx.fillStyle='#6b4f2a'; ctx.fillRect(state.monkey.x-44,state.monkey.y-44,88,88);
    for(const b of state.bananas){ ctx.fillStyle=(b.kind==='rotten')?'#7a5a3a':(b.kind==='gold'?'#ffd84d':(b.kind==='time'?'#7ad1ff':'#ffe065')); ctx.fillRect(b.x-23,b.y-23,46,46); }
  }

  function endGame(){ state.running=false; ctx.fillStyle='rgba(0,0,0,0.45)'; ctx.fillRect(0,0,canvas.width,canvas.height); ctx.fillStyle='#fff'; ctx.fillText(`SCORE ${state.score}`,canvas.width/2,canvas.height/2); ui.shareBtn.classList.remove('hidden'); }
  function share(){ alert('공유 링크 복사!'); }

  async function boot(){ fitCanvas(); draw(); }
  boot();
  </script>
</body>
</html>


