<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover, user-scalable=no" />
  <title>24/7 With DDEOSUNGEE</title>
  <meta name="description" content="24/7 With... BANANA." />
  <style>
    *,*::before,*::after{box-sizing:border-box}

    /* ============================================================================
      NeoDunggeunmo (Neoë‘¥ê·¼ëª¨)
      Copyright Â© 2017-2024, Eunbin Jeong (Dalgona.)
      with reserved font name "Neoë‘¥ê·¼ëª¨" and "NeoDunggeunmo".
    ============================================================================ */
    @font-face{
      font-family: 'NeoDunggeunmo';
      src: url('neodgm.ttf') format('truetype');
      font-weight: 400;
      font-style: normal;
      font-display: swap;
    }

    :root{
      --bg:#fff9e9; --ink:#1f1f1f; --brand:#ffbd2e; --ui:#242424;
      --font: 'NeoDunggeunmo', 'Apple SD Gothic Neo', 'Noto Sans KR', system-ui, sans-serif;

      --logo-height: 50px;
      --logo-pad-y: 3px;
      --logo-pad-x: 12px;
      --logo-gap: 1px;

      --wrap-pad: 12px;
      --wrap-pad-top-extra: 4px;

      /* ìŒì†Œê±° ë²„íŠ¼ ì´ ë†’ì´(ê¸€ì+íŒ¨ë”©) â€” 26~30pxì—ì„œ ë¯¸ì„¸ì¡°ì • ê°€ëŠ¥ */
      --audio-btn-h: 28px;
    }

    html,body{
      height:100%;
      margin:0;
      background:var(--bg); color:var(--ink);
      font-family: var(--font);
      letter-spacing: 0;
      overflow:hidden; overscroll-behavior:none; touch-action:none;
    }

    .wrap{
      height:100dvh; width:100vw;
      display:grid; grid-template-rows:1fr auto auto; gap:10px;
      padding: calc(max(var(--wrap-pad), env(safe-area-inset-top)) + var(--wrap-pad-top-extra))
               max(var(--wrap-pad), env(safe-area-inset-right))
               max(var(--wrap-pad), env(safe-area-inset-bottom))
               max(var(--wrap-pad), env(safe-area-inset-left));
    }

    .logo-fixed{
      position:fixed;
      top: calc(max(var(--wrap-pad), env(safe-area-inset-top)));
      left: calc(max(var(--wrap-pad), env(safe-area-inset-left)));
      z-index: 30;
      display:inline-grid; place-items:center;
      height: var(--logo-height);
      padding: var(--logo-pad-y) var(--logo-pad-x);
      border:2px dashed rgba(0,0,0,.25);
      border-radius:10px;
      background:rgba(255,255,255,.28);
      backdrop-filter:saturate(100%) blur(2px);
      color:#6b6b6b; font-weight:800; font-size:12px;
      user-select:none;
      min-width: 170px;
      font-family: var(--font);
    }
    .logo-fixed img.logo{height:var(--logo-height); width:auto; display:block}
    .logo-fixed.has-img{ border:0; background:transparent; padding:0; min-width:auto; box-shadow:none; backdrop-filter:none; }
    .logo-fixed.has-img img.logo{display:block; height:var(--logo-height); width:auto; filter:none;}

    /* ì¸ê²Œì„ ë°–, ìš°ì¸¡ ìƒë‹¨ ì˜¤ë””ì˜¤ í† ê¸€ â€” ë²„íŠ¼ í•˜ë‹¨ = ë¡œê³  í•˜ë‹¨ ì •ë ¬ */
    .audio-fixed{
      position: fixed;
      top:  calc(
              max(var(--wrap-pad), env(safe-area-inset-top))
              + var(--logo-height)
              - var(--audio-btn-h)
            );
      right: calc(max(var(--wrap-pad), env(safe-area-inset-right)));
      z-index: 40;
      display: inline-grid;
      place-items: center;
    }
    .audio-btn{
      appearance:none; border:0; background:rgba(0,0,0,.35); color:#fff; font-weight:900;
      padding:6px 10px; border-radius:10px; cursor:pointer; font-size:12px; line-height:1;
      box-shadow:0 2px 6px rgba(0,0,0,.2);
    }

    #stage{
      position:relative;
      min-height:0;
      border-radius:14px;
      overflow:hidden;
      margin-top: calc(var(--logo-height) + (var(--logo-pad-y) * 2) + var(--logo-gap));
    }
    canvas{
      image-rendering:pixelated; display:block; width:100%; height:100%;
      background:linear-gradient(0deg,#fff7d1,#fff1b0);
    }

    .hud{
      position:absolute; inset:8px 10px auto 10px;
      display:grid; grid-template-columns:1fr auto 1fr; align-items:center; gap:8px;
      font-weight:900; font-size:14px; text-shadow:0 2px 6px rgba(0,0,0,.25);
      color:#fff; z-index:10; pointer-events:none; font-family: var(--font);
    }
    .hud .left{justify-self:start}
    .hud .center{justify-self:center}
    .hud .right{justify-self:end}

    /* í•˜íŠ¸ë§Œ ì‚´ì§ ì¶•ì†Œ + ì¤„ë°”ê¿ˆ ë°©ì§€ */
    .hud .right{ white-space: nowrap; }
    .hud .right .heart{
      font-size:12px;
      line-height:1;
      display:inline-block;
      transform: translateY(1px);
      margin-right:2px;
    }

    .group{display:flex;gap:10px;flex-wrap:wrap;justify-content:center; align-items:center;}
    #startBtn{ order:1; } #buyBtn{ order:2; } #shareBtn{ order:3; }

    button.btn, a.btn{
      appearance:none; border:none; background:var(--brand); color:#1b1b1b; font-weight:800;
      padding:10px 14px; border-radius:12px; cursor:pointer;
      box-shadow:0 6px 16px rgba(0,0,0,.15); text-decoration:none;
      font-family: var(--font); letter-spacing:.5px;
      font-size:14px; line-height:1; display:inline-flex; align-items:center; justify-content:center; min-height:38px;
    }
    button.btn:active{transform:translateY(1px)}
    .hidden{display:none!important}

    .footer{font-size:11px;opacity:.85;text-align:center;font-family: var(--font)}
    .footer .sep{opacity:.4;margin:0 6px}
    .footer a{ text-decoration:none; }
    .footer a.copyright{ text-decoration:underline; }

    .start-overlay{
      position:absolute; inset:0; display:grid; place-items:center; text-align:center;
      background:rgba(0,0,0,.35); color:#fff; padding:20px; z-index:20; font-family: var(--font);
    }
    .start-box{
      background:rgba(0,0,0,.35); border-radius:12px; padding:16px 18px; max-width:min(90%,520px);
      /* íŒ¨ë„ ë‚´ë¶€ë§Œ ì»¤ì§€ê³ , ë„˜ì¹˜ë©´ ë‚´ë¶€ ìŠ¤í¬ë¡¤ */
      max-height: calc(100% - 24px);
      overflow: auto;
      -webkit-overflow-scrolling: touch;
    }
    .start-title{font:900 22px var(--font); margin-bottom:8px}
    .start-sub{font:800 18px var(--font); margin-bottom:8px}
    .start-help{font:600 14px var(--font); opacity:.95; line-height:1.5}
  </style>
</head>
<body>
  <div class="logo-fixed" id="logoSlot">LOGO PNG</div>

  <!-- ì¸ê²Œì„ ë°–, ìš°ì¸¡ ìƒë‹¨ ì˜¤ë””ì˜¤ í† ê¸€ -->
  <div class="audio-fixed">
    <button id="audioBtn" class="audio-btn" aria-label="BGM í† ê¸€">ğŸ”‡</button>
  </div>

  <div class="wrap">
    <div id="stage" aria-label="WITH Monkey Game Stage">
      <canvas id="game" width="360" height="640"></canvas>

      <div class="hud" id="hud">
        <div class="left">ì ìˆ˜: <span id="score">0</span></div>
        <div class="center">ë‚¨ì€ì‹œê°„: <span id="time">30</span>s</div>
        <div class="right">
          <span class="heart" aria-hidden="true">â¤ï¸</span>
          <span id="lives">3</span> Â· ìµœê³ : <span id="best">0</span>
        </div>
      </div>

      <div class="start-overlay" id="startOverlay" role="dialog" aria-modal="true">
        <div class="start-box">
          <div class="start-title">Banana Time!</div>
          <div class="start-sub">ë“œë˜ê·¸í•˜ì—¬ ì´ë™ Â· ì‹œê°„ì´ ë‹¤ ë˜ê±°ë‚˜ í•˜íŠ¸ 3ê°œë¥¼ ë‹¤ ìƒìœ¼ë©´ ê²Œì„ ì˜¤ë²„</div>
          <div class="start-help">ê³¨ë“  ë°”ë‚˜ë‚˜(+5) Â· ì©ì€ ë°”ë‚˜ë‚˜(â¤ï¸ -1) Â· ì‹œê°„ ë°”ë‚˜ë‚˜(â± +3s)</div>
        </div>
      </div>
    </div>

    <div class="group">
      <button class="btn" id="startBtn">ë– ìˆ­ì´ ë°¥ì£¼ê¸°</button>
      <a class="btn hidden" id="buyBtn"
         href="https://takemm.com/prod/view/52971"
         target="_blank" rel="noopener"
         aria-label="TO GET DDEO">TO GET DDEO</a>
      <button class="btn hidden" id="shareBtn">ê³µìœ í•˜ê¸°</button>
    </div>

    <div class="footer">
      X(@ddeosungee)
      <span class="sep">Â·</span>
      <a class="copyright" href="neodgm-LICENSE.txt" target="_blank" rel="noopener">
        Copyright Â© 2017-2024, Eunbin Jeong (Dalgona.) &lt;project-neodgm@dalgona.dev&gt;
        with reserved font name "Neoë‘¥ê·¼ëª¨" and "NeoDunggeunmo".
      </a>
    </div>
  </div>

  <!-- BGM: WAV ë‹¨ì¼ src -->
  <audio id="bgm" loop preload="auto" src="/bgm.wav"></audio>

  <script src="https://unpkg.com/three@0.160.0/build/three.min.js"></script>
  <script>
  const CONFIG = {
    GAME_SECONDS: 30,
    MONKEY_SPEED: 6,
    BASE_SPAWN: 34,
    FALL_MIN: 2,
    FALL_MAX: 5,
    GOLDEN_CHANCE: 0.08,
    ROTTEN_CHANCE: 0.04,
    DRIFT_SIN_MIN: 0.1,
    DRIFT_SIN_MAX: 0.8,
    DRIFT_FREQ_MIN: 0.04,
    DRIFT_FREQ_MAX: 0.10,
    PAIR_CHANCE: 0.28,
    PAIR_SPACING: 42,
    TIMEBANANA_PERIOD_S: 4,
    TIMEBANANA_JITTER_S: 2,
    TIMEBANANA_ADD_S: 3,
    TITLE_TEXT: "Banana Time",
    HIGH_SCORE_TUNE_START: 400,
    ROTTEN_MULT_AFTER: 0.6,
    PAIR_MULT_AFTER: 0.7,
    MAX_CONSEC_ROTTEN: 2,
    TIMEBANANA_PERIOD_MULT_AFTER: 0.85
  };

  const clamp=(x,a,b)=>Math.max(a,Math.min(b,x));
  const lerp=(a,b,t)=>a+(b-a)*t;
  const rand=(min,max)=>Math.random()*(max-min)+min;
  const hit=(a,b)=>Math.abs(a.x-b.x)<(a.w/2+b.w/2)&&Math.abs(a.y-b.y)<(a.h/2+b.h/2);
  const ASSET_BASE = new URL('./', location.href);
  const asset = (name) => new URL(name, ASSET_BASE).toString();

  const canvas=document.getElementById('game');
  const stage=document.getElementById('stage');
  const ui={
    score:document.getElementById('score'), time:document.getElementById('time'), best:document.getElementById('best'),
    lives:document.getElementById('lives'), startBtn:document.getElementById('startBtn'),
    shareBtn:document.getElementById('shareBtn'), buyBtn:document.getElementById('buyBtn'),
    startOverlay:document.getElementById('startOverlay'), audioBtn:document.getElementById('audioBtn')
  };

  const bgmEl=document.getElementById('bgm');
  let bgmEnabled=true;

  const state={
    running:false, frame:0, score:0, timeLeft:CONFIG.GAME_SECONDS, lives:3, shake:0,
    monkey:{x:180,y:568,w:56,h:56}, bananas:[], spawnEvery:CONFIG.BASE_SPAWN,
    timeBananaFrames:0, rafId:null, lastTick:0, consecRotten:0,
    assets:{monkey:null, monkeyHurt:null, gold:null, rotten:null, time:null, bg:null, logo:null},
    monkeyFlash:0
  };

  const scene=new THREE.Scene();
  const camera=new THREE.PerspectiveCamera(52, 1, 0.1, 2000);
  camera.position.set(0, 40, 680);
  const renderer=new THREE.WebGLRenderer({canvas, antialias:true, alpha:false});
  renderer.setPixelRatio(Math.min(window.devicePixelRatio||1, 2));

  const world={root:new THREE.Group(), bg:null, floor:null, monkey:null, monkeyHurt:null, bananas:[]};
  scene.add(world.root);
  scene.add(new THREE.AmbientLight(0xffffff, 1.1));
  const sun=new THREE.DirectionalLight(0xfff3cf, 0.9);
  sun.position.set(-200, 260, 320);
  scene.add(sun);

  function pxToWorld(x,y,z=0){ return new THREE.Vector3(x - canvas.width/2, canvas.height/2 - y, z); }
  function createCard(texture,w,h,opts={}){
    const g=new THREE.PlaneGeometry(w,h);
    const m=new THREE.MeshStandardMaterial({
      map:texture||null,
      transparent:!!texture,
      color:opts.color||0xffffff,
      roughness:0.7,
      metalness:0.05
    });
    const mesh=new THREE.Mesh(g,m);
    mesh.castShadow=false;
    return mesh;
  }

  function refreshAudioButton(){ ui.audioBtn.textContent=bgmEnabled?'ğŸ”Š':'ğŸ”‡'; }
  function playBGM(reset){ if(!bgmEnabled) return; if(reset) bgmEl.currentTime=0; bgmEl.volume=0.7; bgmEl.play().catch(()=>{}); }
  function pauseBGM(){ try{ bgmEl.pause(); }catch{} }
  function setMuted(muted){ bgmEnabled=!muted; muted?pauseBGM():playBGM(false); refreshAudioButton(); }

  function fitCanvas(){
    const W=stage.clientWidth, H=stage.clientHeight;
    renderer.setSize(W,H,false);
    camera.aspect=W/H;
    camera.updateProjectionMatrix();
    state.monkey.y = H - 70;
    if(world.bg){ world.bg.scale.set(W, H, 1); world.bg.position.set(0,0,-140); }
    if(world.floor){ world.floor.scale.set(W, 8, 1); world.floor.position.copy(pxToWorld(W/2,H-18,-20)); }
  }
  addEventListener('resize', fitCanvas);
  addEventListener('orientationchange', fitCanvas);

  function updateWorld(){
    if(world.monkey){
      const p=pxToWorld(state.monkey.x,state.monkey.y,30);
      world.monkey.position.copy(p);
      world.monkey.rotation.y = THREE.MathUtils.degToRad((state.monkey.x - canvas.width/2) * 0.05);
      world.monkey.material.opacity = state.monkeyFlash>0 ? 0.6 : 1;
    }
    if(world.monkeyHurt){
      world.monkeyHurt.position.copy(pxToWorld(state.monkey.x,state.monkey.y,31));
      world.monkeyHurt.visible = state.monkeyFlash>0;
    }

    const byId = new Map(world.bananas.map(x=>[x.id,x]));
    for(const b of state.bananas){
      let it=byId.get(b.id);
      if(!it){
        const tex = b.kind==='gold'?state.assets.gold:b.kind==='rotten'?state.assets.rotten:state.assets.time;
        const card=createCard(tex,b.w,b.h,{color:b.kind==='time'?0x9be3ff:0xffffff});
        card.userData.id=b.id;
        world.root.add(card);
        world.bananas.push(card);
        it=card;
      }
      it.position.copy(pxToWorld(b.x,b.y,b.kind==='time'?8:18));
      it.rotation.z += 0.03;
      it.rotation.x = Math.sin(state.frame*0.05 + b.phase) * 0.35;
    }
    world.bananas = world.bananas.filter(mesh=>{
      const exists = state.bananas.some(b=>b.id===mesh.userData.id);
      if(!exists){ world.root.remove(mesh); mesh.geometry.dispose(); mesh.material.dispose(); }
      return exists;
    });

    camera.position.x = state.shake>0 ? rand(-10,10) : 0;
    camera.position.y = 40 + (state.shake>0 ? rand(-7,7) : 0);
  }

  function currentChances(score){
    let gold=CONFIG.GOLDEN_CHANCE, rotten=CONFIG.ROTTEN_CHANCE, pair=CONFIG.PAIR_CHANCE;
    if(score>=CONFIG.HIGH_SCORE_TUNE_START){ rotten*=CONFIG.ROTTEN_MULT_AFTER; pair*=CONFIG.PAIR_MULT_AFTER; }
    return {gold,rotten,pair};
  }

  function spawnOne(kind){
    const speed=lerp(CONFIG.FALL_MIN,CONFIG.FALL_MAX+state.score*0.02,Math.random());
    state.bananas.push({id:crypto.randomUUID(),kind,x:rand(24,canvas.width-24),y:-30,vx:(Math.random()-0.5)*0.8,vy:speed,w:46,h:46,phase:Math.random()*Math.PI*2,sinAmp:lerp(CONFIG.DRIFT_SIN_MIN,CONFIG.DRIFT_SIN_MAX,Math.random()),sinFreq:lerp(CONFIG.DRIFT_FREQ_MIN,CONFIG.DRIFT_FREQ_MAX,Math.random()),ax:0});
  }
  function spawnPair(){
    const center=rand(60,canvas.width-60), spacing=CONFIG.PAIR_SPACING, leftX=clamp(center-spacing,24,canvas.width-24), rightX=clamp(center+spacing,24,canvas.width-24);
    const speed=lerp(CONFIG.FALL_MIN,CONFIG.FALL_MAX+state.score*0.02,Math.random());
    const goldLeft=Math.random()<0.5;
    state.bananas.push({id:crypto.randomUUID(),kind:goldLeft?'gold':'rotten',x:leftX,y:-30,vx:-0.35,vy:speed,w:46,h:46,phase:Math.random()*6,sinAmp:rand(0.15,0.7),sinFreq:rand(0.04,0.08),ax:0});
    state.bananas.push({id:crypto.randomUUID(),kind:goldLeft?'rotten':'gold',x:rightX,y:-30,vx:0.35,vy:speed*1.02,w:46,h:46,phase:Math.random()*6,sinAmp:rand(0.15,0.7),sinFreq:rand(0.04,0.08),ax:0});
  }
  function spawnOneWeighted(){
    const {gold,rotten}=currentChances(state.score);
    let kind;
    if(state.consecRotten>=CONFIG.MAX_CONSEC_ROTTEN) kind='gold';
    else kind=(Math.random() < (rotten/((gold+rotten)||1))) ? 'rotten':'gold';
    state.consecRotten = kind==='rotten' ? state.consecRotten+1 : 0;
    spawnOne(kind);
  }
  function spawnTimeBanana(){ spawnOne('time'); }
  function resetTimeBananaTimer(){
    let period=CONFIG.TIMEBANANA_PERIOD_S + (Math.random()*2-1)*CONFIG.TIMEBANANA_JITTER_S;
    if(state.score>=CONFIG.HIGH_SCORE_TUNE_START) period*=CONFIG.TIMEBANANA_PERIOD_MULT_AFTER;
    state.timeBananaFrames=Math.max(2,Math.round(period*60));
  }

  function update(){
    if(keys.has('ArrowLeft')||keys.has('a')) state.monkey.x-=CONFIG.MONKEY_SPEED;
    if(keys.has('ArrowRight')||keys.has('d')) state.monkey.x+=CONFIG.MONKEY_SPEED;
    state.monkey.x=clamp(state.monkey.x, state.monkey.w/2, canvas.width-state.monkey.w/2);

    if(state.frame % state.spawnEvery === 0){
      const chances=currentChances(state.score);
      Math.random() < chances.pair ? spawnPair() : spawnOneWeighted();
    }
    state.timeBananaFrames--; if(state.timeBananaFrames<=0){ spawnTimeBanana(); resetTimeBananaTimer(); }

    for(let i=state.bananas.length-1;i>=0;i--){
      const b=state.bananas[i];
      b.ax += (Math.random()*2-1)*0.02; b.ax=clamp(b.ax,-0.02,0.02);
      b.vx=clamp(b.vx+b.ax,-1.6,1.6);
      b.x += b.vx + Math.sin(state.frame*b.sinFreq+b.phase)*b.sinAmp;
      b.y += b.vy;
      const half=b.w/2;
      if(b.x<half){ b.x=half; b.vx=Math.abs(b.vx)*0.6; }
      if(b.x>canvas.width-half){ b.x=canvas.width-half; b.vx=-Math.abs(b.vx)*0.6; }

      if(hit(b,state.monkey)){
        state.bananas.splice(i,1);
        if(b.kind==='rotten'){ state.lives=Math.max(0,state.lives-1); ui.lives.textContent=state.lives; state.shake=18; state.monkeyFlash=14; }
        else if(b.kind==='time'){ state.timeLeft=Math.min(state.timeLeft+CONFIG.TIMEBANANA_ADD_S, CONFIG.GAME_SECONDS+10); ui.time.textContent=state.timeLeft; }
        else { state.score+=5; ui.score.textContent=state.score; }
        if(state.score%6===0&&state.score>0) state.spawnEvery=Math.max(14,state.spawnEvery-1);
      } else if(b.y>canvas.height+40){ state.bananas.splice(i,1); }
    }
    if(state.shake>0) state.shake--; if(state.monkeyFlash>0) state.monkeyFlash--;
  }

  function render(){ updateWorld(); renderer.render(scene,camera); }

  function endGame(){
    state.running=false;
    if(state.rafId){ cancelAnimationFrame(state.rafId); state.rafId=null; }
    const best=Number(localStorage.getItem('bestScore')||0);
    if(state.score>best){ localStorage.setItem('bestScore', String(state.score)); ui.best.textContent=state.score; }
    else ui.best.textContent=best;
    ui.shareBtn.classList.remove('hidden'); ui.buyBtn.classList.remove('hidden');
    ui.startOverlay.classList.remove('hidden');
    ui.startOverlay.querySelector('.start-title').textContent='Banana Time Over!';
    ui.startOverlay.querySelector('.start-sub').textContent=`SCORE ${state.score}`;
    ui.startOverlay.querySelector('.start-help').textContent='ë‹¤ì‹œ ì‹œì‘í•´ì„œ ìµœê³ ê¸°ë¡ì„ ê°±ì‹ í•´ë³´ì„¸ìš”.';
    pauseBGM();
    render();
  }

  function loop(now){
    if(!state.running) return;
    const dt=(now-state.lastTick)/1000||0; state.lastTick=now;
    state.timeLeft=Math.max(0,state.timeLeft-dt); ui.time.textContent=Math.ceil(state.timeLeft);
    state.frame++;
    update();
    render();
    if(state.timeLeft<=0||state.lives<=0){ endGame(); return; }
    state.rafId=requestAnimationFrame(loop);
  }

  const keys=new Set();
  addEventListener('keydown',e=>keys.add(e.key)); addEventListener('keyup',e=>keys.delete(e.key));
  let touchStartX=null;
  function pointerStart(clientX){const rect=canvas.getBoundingClientRect(); touchStartX=(clientX-rect.left)*(canvas.width/rect.width);}
  function pointerMove(clientX){ if(touchStartX===null) return; const rect=canvas.getBoundingClientRect(); const x=(clientX-rect.left)*(canvas.width/rect.width); const dx=x-touchStartX; state.monkey.x=clamp(state.monkey.x+dx*1.3, state.monkey.w/2, canvas.width-state.monkey.w/2); touchStartX=x; }
  function mouseMoveHandler(e){pointerMove(e.clientX);}  
  canvas.addEventListener('mousedown',e=>{pointerStart(e.clientX); canvas.addEventListener('mousemove',mouseMoveHandler);});
  canvas.addEventListener('touchstart',e=>{if(e.touches[0]) pointerStart(e.touches[0].clientX);},{passive:true});
  canvas.addEventListener('touchmove',e=>{if(e.touches[0]) pointerMove(e.touches[0].clientX);},{passive:true});
  addEventListener('mouseup',()=>{touchStartX=null; canvas.removeEventListener('mousemove',mouseMoveHandler);});
  addEventListener('touchend',()=>{touchStartX=null;},{passive:true});

  function share(){
    const body=['#ë– ìˆ­ì´_ë°¥ì£¼ê¸°â›§',`âŠ‚(${state.score}ì ì„ íšë“í–ˆì–´ìš”)âŠƒâ³Š`,'â€‹',location.href].join('\n');
    if(navigator.share) return navigator.share({title:`${CONFIG.TITLE_TEXT} â€” SCORE ${state.score}`,text:body}).catch(()=>{});
    const url='https://twitter.com/intent/tweet?text='+encodeURIComponent(body);
    const win=window.open(url,'_blank','noopener');
    if(!win){ navigator.clipboard?.writeText(body).catch(()=>{}); }
  }

  function startGame(){
    if(state.rafId){ cancelAnimationFrame(state.rafId); state.rafId=null; }
    state.running=true; state.frame=0; state.score=0; state.timeLeft=CONFIG.GAME_SECONDS; state.lives=3; state.shake=0; state.monkeyFlash=0;
    state.bananas=[]; state.spawnEvery=CONFIG.BASE_SPAWN; state.consecRotten=0;
    ui.score.textContent='0'; ui.time.textContent=String(CONFIG.GAME_SECONDS); ui.lives.textContent='3';
    ui.startBtn.textContent='ë‹¤ì‹œ ì‹œì‘'; ui.shareBtn.classList.add('hidden'); ui.buyBtn.classList.add('hidden'); ui.startOverlay.classList.add('hidden');
    state.monkey.x=canvas.width/2; state.monkey.y=canvas.height-70;
    resetTimeBananaTimer(); state.lastTick=performance.now(); state.rafId=requestAnimationFrame(loop);
  }

  ui.startBtn.addEventListener('click',()=>{ startGame(); playBGM(true); });
  ui.shareBtn.addEventListener('click',share);
  ui.audioBtn.addEventListener('click',()=>setMuted(bgmEnabled));
  document.addEventListener('pointerdown',()=>playBGM(true),{once:true});

  async function loadTexture(name){
    return new Promise(resolve=>new THREE.TextureLoader().load(asset(name), tex=>{ tex.colorSpace=THREE.SRGBColorSpace; resolve(tex); }, undefined, ()=>resolve(null)));
  }

  async function boot(){
    const [monkey,gold,rotten,time,bg,monkeyHurt,logo]=await Promise.all([
      loadTexture('monkey.png'),loadTexture('banana_gold.png'),loadTexture('banana_rotten.png'),loadTexture('banana_time.png'),
      loadTexture('background.png'),loadTexture('monkey_hurt.png'),loadTexture('logo.png')
    ]);
    state.assets={monkey,gold,rotten,time,bg,monkeyHurt,logo};

    world.bg=createCard(bg, 1, 1, {color:0xffffff});
    world.floor=createCard(null, 1, 1, {color:0x000000}); world.floor.material.opacity=0.18; world.floor.material.transparent=true;
    world.monkey=createCard(monkey, state.monkey.w, state.monkey.h, {color:0xffffff});
    world.monkeyHurt=createCard(monkeyHurt, state.monkey.w, state.monkey.h, {color:0xffffff}); world.monkeyHurt.visible=false;
    world.root.add(world.bg,world.floor,world.monkey,world.monkeyHurt);

    fitCanvas();
    ui.best.textContent=localStorage.getItem('bestScore')||'0';
    const slot=document.getElementById('logoSlot');
    if(logo){ slot.classList.add('has-img'); slot.innerHTML=`<img class="logo" src="${asset('logo.png')}" alt="24/7 WITH DDEOSUNGEE">`; }
    refreshAudioButton();
    render();
  }

  if(document.readyState!=='loading') boot(); else addEventListener('DOMContentLoaded',boot);
  </script>
</body>
</html>
